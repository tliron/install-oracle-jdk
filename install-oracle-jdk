#!/bin/bash
set -e

HERE=$(dirname "$(readlink -f "$0")")
. "$HERE/config"

function install-bin()
{
	NAME=$1
	if [ -f "$BASE/$ALIAS/man/man1/$NAME.1" ]; then
		update-alternatives --quiet --install "/usr/bin/$NAME" "$NAME" "$BASE/$ALIAS/bin/$NAME" 100 --slave "/usr/share/man/man1/$NAME.1" "$NAME.1" "$BASE/$ALIAS/man/man1/$NAME.1"
	else
		update-alternatives --quiet --install "/usr/bin/$NAME" "$NAME" "$BASE/$ALIAS/bin/$NAME" 100
	fi
}

function install-lib()
{
	NAME=$1
	SRC=$2
	LOCATION=$3
	update-alternatives --quiet --install "$LOCATION" "$NAME" "$BASE/$ALIAS/jre/lib/amd64/$SRC" 100
}

if [ ! -d "/usr/lib/jvm/$DIR" ]; then
	cd /tmp
	
	# Download
	if [ ! -f "$ARCHIVE.tar.gz" ]; then
		wget --no-check-certificate -c --header "Cookie: oraclelicense=accept-securebackup-cookie" "http://download.oracle.com/otn-pub/java/jdk/$SITE/$ARCHIVE.tar.gz"
	fi

	# Extract
	cd /tmp
	tar xzvf "$ARCHIVE.tar.gz"
	
	# Move
	mkdir -p "$BASE"
	mv "$DIR" "$BASE"

	# Alias
	rm -f "$BASE/$ALIAS"
	cd "$BASE"
	ln -sf "$DIR" "$ALIAS"
	
	# jinfo
	echo "$HERE/java-8-oracle.jinfo"
	cp -f "$HERE/java-8-oracle.jinfo" "$BASE/.java-8-oracle.jinfo"

	set +e

	for NAME in "$BASE/$ALIAS/bin/"*; do
		install-bin $(basename "$NAME")
	done

	install-lib xulrunner-1.9-javaplugin.so libnpjp2.so /usr/lib/xulrunner-addons/plugins/libjavaplugin.so
	install-lib mozilla-javaplugin.so libnpjp2.so /usr/lib/mozilla/plugins/libjavaplugin.so
	
	update-java-alternatives -s "$ALIAS"
fi
